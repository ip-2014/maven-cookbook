<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="osgi">
  <title>Cooking with Maven and OSGi</title>

  <section id="using-sect-intro">
    <title>Introduction</title>

    <para>OSGi is a developing standard... well, that's not entirely true,
    OSGi is stable, has been around for many years, and is only now beginning
    to capture the attention of most mainstream developers. If you've been
    using Eclipse, you've already been using an OSGi container for a few
    years, and the pluggable and configurable nature of the Eclipse platform
    is a product of the OSGi standards. As a concept and as an approach, OSGi
    is a proven standard with an installed user base of millions and growing;
    as a mainstream development methodology, OSGi is just arriving on the
    scene. It might feel like an emerging standard because solid tool support
    is just now emerging. Prior to the last year, you might have encountered
    OSGi "builds", but they were usually experienced via an IDE (such as
    Eclipse).</para>

    <para>Many are starting to view OSGi as the perfect solution both for
    deploying server-side applications and client-side GUI application, it is
    a common standard and format that meshes very well with the al-la-carte
    model of open source development that has recently come of age. If you
    need a GUI front-end or a web application to interface with a database
    backend, there is a rich array of standard components to choose from in
    the OSGi community. Before OSGi-based servers, if you wanted a full
    fledged application server with a Transaction provider and JMS integration
    you had to either run something involved like JBoss or Websphere, or you
    had to hack some custom components to a lightweight servlet-container such
    as Tomcat or Jetty. Today, you wouldn't install Jetty from scratch, you
    will install it as an OSGi bundle in an OSGi container such as Apache
    Felix. If you needed an embedded database like Derby or a transaction
    provider, you can now tell your container what bundles to deploy and every
    component is developed to operate in a standard operating environment.
    Once you've figured out how to instantiate a empty OSGi container such as
    Apache Felix there is no simpler deployment mechanism for your
    application.</para>

    <para>In this chapter, we introduce some tools and techniques you can use
    to start developing OSGi components (or bundles) using Maven. The
    following recipes focus on the intersection of Apache Felix, the OPS4J
    project, and the Nexus repository manager as a bridge between Maven
    repositories and OSGi Bundle repositories. At the end of this chapter, you
    should have a clear picture of how to start developing OSGi-based web
    applications using nothing more than Maven.</para>
  </section>

  <section id="sect-osgi-generate-project">
    <title>Generating an OSGi Project with Maven</title>

    <section>
      <title>Problem</title>

      <para>You need to create a Maven multi-module project that allows you to
      develop a modular, OSGi-based web application.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>Use the Maven Pax Plugin from OPS4J, and call the
      <varname>create-project</varname> goal. The following command-line will
      create a multi-module project with a groupId of
      <varname>org.sonatype.mcookbook</varname>, an artifactId of
      <varname>osgi-project</varname>, and a version of
      <varname>1.0-SNAPSHOT</varname>:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi $ <command>mvn org.ops4j:maven-pax-plugin:create-project \
  -DgroupId=org.sonatype.mcookbook \
  -DartifactId=osgi-project \
  -Dversion=1.0-SNAPSHOT</command>
[INFO] Scanning for projects...
[INFO] artifact org.ops4j:maven-pax-plugin: checking for updates from central
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Default Project
[INFO]    task-segment: [org.ops4j:maven-pax-plugin:create-project] (aggregator-style)
[INFO] ------------------------------------------------------------------------
...
[INFO] [pax:create-project]
[INFO] Selecting latest archetype release within version range [1,2)
[INFO] artifact org.ops4j.pax.construct:maven-archetype-osgi-project: checking for updates from central
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating Archetype: maven-archetype-osgi-project:1.0.3
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: packageName, Value: org.sonatype.mcookbook.osgi-project
[INFO] Parameter: archetypeVersion, Value: 1.0.3
[INFO] Parameter: groupId, Value: org.sonatype.mcookbook
[INFO] Parameter: archetypeArtifactId, Value: maven-archetype-osgi-project
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] Parameter: archetypeGroupId, Value: org.ops4j.pax.construct
[INFO] Parameter: basedir, Value: ${root.example.dir}/osgi
[INFO] Parameter: package, Value: org.sonatype.mcookbook.osgi-project
[INFO] Parameter: artifactId, Value: osgi-project
[INFO] ********************* End of debug info from resources from generated POM ***********************
[INFO] Archetype created in dir: ${root.example.dir}/osgi/osgi-project
</screen>

      <para>Once you've generated an OSGi project using the Pax Plugin, you
      will have the following directory structure:</para>

      <figure>
        <title>Project Structure Created by the OPS4J Pax Plugin</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="figs/web/osgi_osgi-project-filesystems.png" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>If you want to verify that you can build the project successfully,
      run <command>mvn clean install</command>:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn clean install</command>
[INFO] Reactor build order: 
[INFO]   org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]   osgi-project - plugin configuration
[INFO]   osgi-project - wrapper instructions
[INFO]   osgi-project - bundle instructions
[INFO]   osgi-project - imported bundles
[INFO] ------------------------------------------------------------------------
[INFO] Building org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]    task-segment: [clean, install]
[INFO] ------------------------------------------------------------------------
[INFO] [clean:clean]
[INFO] [site:attach-descriptor]
[INFO] [install:install]
[INFO] Installing ${root.example.dir}/osgi/osgi-project/target/pom-transformed.
xml to ${local.repo.dir}/org/sonatype/mcookbook/osgi-project/1.0-SNAPS
HOT/osgi-project-1.0-SNAPSHOT.pom
[INFO] ------------------------------------------------------------------------
[INFO] Building osgi-project - plugin configuration
[INFO]    task-segment: [clean, install]
...</screen>
    </section>

    <section>
      <title>Discussion</title>

      <para>The generated multi-module project structure contains a parent
      project with the supplied groupId, artifactId, and version, and a few
      submodules:</para>

      <variablelist>
        <varlistentry>
          <term>osgi-project/pom.xml</term>

          <listitem>
            <para>This is the parent POM</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/poms/pom.xml</term>

          <listitem>
            <para></para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/poms/compiled/pom.xml</term>

          <listitem>
            <para></para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/poms/wrappers/pom.xml</term>

          <listitem>
            <para></para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/provision/pom.xml</term>

          <listitem>
            <para></para>
          </listitem>
        </varlistentry>
      </variablelist>

      <para>In addition to these projects, the osgi-project directory also
      contains a directory that captures the configuration of the runtime
      environment. This runner directory contains the following files and
      directories:</para>

      <variablelist>
        <varlistentry>
          <term>osgi-project/runner/deploy-pom.xml</term>

          <listitem>
            <para>This POM file is generated using Pax-Construct, it contains
            some configuration parameters for the Apache Felix
            container.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/runner/bundles</term>

          <listitem>
            <para>This directory contains OSGi bundles which have been
            downloaded for use in Apache Felix.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>osgi-project/runner/felix</term>

          <listitem>
            <para>This directory contains the runtime files that are required
            for Apache Felix, this includes a config.ini file and a cache
            directory.</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </section>
  </section>

  <section>
    <title>Starting an OSGi Container</title>

    <section>
      <title>Problem</title>

      <para>You created an OSGi project, not you want to see it running in an
      OSGi environment. You need to start an OSGi container and load imported
      bundles into the runtime environment.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>First, creat an OSGi project by executing the commands in <xref
      linkend="sect-osgi-generate-project" />. Once you do this, you have a
      structure that has been designed to support OSGi development with Maven.
      To start the Apache Felix container, run <command>mvn install
      pax:provision</command> from the <filename>osgi-project/</filename>
      directory:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn install pax:provision</command>
[INFO] Scanning for projects...
[INFO] Reactor build order: 
[INFO]   org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]   osgi-project - plugin configuration
[INFO]   osgi-project - wrapper instructions
[INFO]   osgi-project - bundle instructions
[INFO]   osgi-project - imported bundles
...
[INFO] [pax:provision]
[INFO] ~~~~~~~~~~~~~~~~~~~
[INFO]  No bundles found! 
[INFO] ~~~~~~~~~~~~~~~~~~~
    ______  ________  __  __
   / __  / /  __   / / / / /
  /  ___/ /  __   / _\ \ _/
 /  /    /  / /  / / _\ \
/__/    /__/ /__/ /_/ /_/

Pax Runner (1.0.0) from OPS4J - http://www.ops4j.org
----------------------------------------------------

 -&gt; Using config [classpath:META-INF/runner.properties]
 -&gt; Using only arguments from command line
 -&gt; Scan bundles from [${root.example.dir}/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Scan bundles from [scan-pom:file:/${root.example.dir}/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Preparing framework [Felix 1.8.0]
 -&gt; Downloading bundles...
 -&gt; Using execution environment [J2SE-1.5]
 -&gt; Runner has successfully finished his job!


Welcome to Felix.
=================

-&gt; 
</screen>
    </section>

    <section>
      <title>Discussion</title>

      <para>When you started up Felix, notice that the line directly following
      the execution of the <varname>pax:provision</varname> goal says "No
      bundles found!". By running <varname>pax:provision</varname>, you've
      started the Felix OSGi service platform. Felix uses the configuration
      from a properties file and then scans two deploy-pom.xml files for
      bundles that it should download and install. Finding none, it presents a
      simple prompt and awaits orders. At this point, we have an empty
      container that isn't running any custom logic or downloading any OSGi
      bundles. Over the next few recipes we're going to fill in this picture a
      bit by wrapping existing JARs, importing existing OSGi bundles, and
      writing a custom OSGi service.</para>

      <para>Once you have the console for Felix loaded, you can control the
      platform, load components from remote repositories, list all of the
      running components, and start and stop components. Try executing the
      command <command>help</command> to see a list of available
      commands:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">-&gt; <command>help</command>
bundlelevel &lt;level&gt; &lt;id&gt; ... | &lt;id&gt; - set or get bundle start level.
cd [&lt;base-URL&gt;]                     - change or display base URL.
exports &lt;id&gt; ...                    - list exported packages.
headers [&lt;id&gt; ...]                  - display bundle header properties.
help                                - display impl commands.
imports &lt;id&gt; ...                    - list imported packages.
install &lt;URL&gt; [&lt;URL&gt; ...]           - install bundle(s).
ps [-l | -s | -u]                   - list installed bundles.
refresh [&lt;id&gt; ...]                  - refresh packages.
requirers &lt;id&gt; ...                  - list requiring bundles.
requires &lt;id&gt; ...                   - list required bundles.
resolve [&lt;id&gt; ...]                  - attempt to resolve the specified bundles.
scr help                            - Declarative Services Runtime
services [-u] [-a] [&lt;id&gt; ...]       - list registered or used services.
shutdown                            - shutdown framework.
start [-t] &lt;id&gt; [&lt;id&gt; &lt;URL&gt; ...]    - start bundle(s).
startlevel [&lt;level&gt;]                - get or set framework start level.
stop [-t] &lt;id&gt; [&lt;id&gt; ...]           - stop bundle(s).
uninstall &lt;id&gt; [&lt;id&gt; ...]           - uninstall bundle(s).
update &lt;id&gt; [&lt;URL&gt;]                 - update bundle.
version                             - display version of framework.
</screen>

      <para>If you execute the <command>ps</command> command, you can see a
      list of bundles with IDs that are running in the Felix container. You
      can start and stop bundles by running <command>start</command> and
      <command>stop</command> followed by the ID of the specific bundle you
      want to control. You can also install and uninstall bundles in the
      running container. </para>
    </section>

    <section>
      <title>Resources</title>

      <para>For more information about Apache Felix, see <ulink
      url="http://felix.apache.org/site/index.html">http://felix.apache.org/site/index.html</ulink>.</para>
    </section>
  </section>

  <section>
    <title>Importing OSGi Bundles with Maven</title>

    <section>
      <title>Problem</title>

      <para>You want to configure your OSGi runtime to load bundles on
      startup.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>Import OSGi bundles from the Maven repository. While the Maven
      repository wasn't designed for OSGi like the OBR repository format, it
      contains a few components which contain the appropriate metadata to be
      referenced as OSGi components. To configure your runtime environment to
      load these components at runtime, you will need to invoke the
      pax:import-bundle goal.</para>

      <para>As shown in the following screen listing, you are going to import
      several OSGi bundles from the Maven repository. First you are going to
      install the Apache Felix Web Management Console and then you are going
      to install some of its requirements. To install the first OSGi bundle
      run the following command:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn pax:import-bundle \
    -DgroupId=org.apache.felix \
    -DartifactId=org.apache.felix.webconsole \
    -Dversion=1.2.8</command>
[INFO] Scanning for projects...
[INFO] Reactor build order: 
[INFO]   org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]   osgi-project - plugin configuration
[INFO]   osgi-project - wrapper instructions
[INFO]   osgi-project - bundle instructions
[INFO]   osgi-project - imported bundles
[INFO] ------------------------------------------------------------------------
[INFO] Building org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]    task-segment: [pax:import-bundle] (aggregator-style)
[INFO] ------------------------------------------------------------------------
[INFO] [pax:import-bundle]
Downloading: http://repo1.maven.org/maven2/org/apache/felix/org.apache.felix.webconsole/1.2.8/org.apache.felix.webconsole-1.2.8.pom
6K downloaded  (org.apache.felix.webconsole-1.2.8.pom)
Downloading: http://repo1.maven.org/maven2/org/apache/felix/felix/1.0.4/felix-1.0.4.pom
14K downloaded  (felix-1.0.4.pom)
[INFO] Importing Apache Felix Web Management Console to org.sonatype.mcookbook.osgi-project.build:provision:pom:1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESSFUL
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 6 seconds
[INFO] Finished at: Mon Jul 13 18:30:37 CDT 2009
[INFO] Final Memory: 8M/16M
[INFO] ------------------------------------------------------------------------
</screen>

      <para>After installing the Apache Felix Web Management console, you will
      need to install some of its prerequisites. The following commands
      install version 2.1 of the Java Servlet API, the Jetty HTTP server, and
      the <varname>org.apache.felix.scr</varname> component. As you can see,
      some of the OSGi bundle you are installing are simple libraries and
      APIs, while others are complex servers.</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn pax:import-bundle \
    -DgroupId=org.apache.felix \
    -DartifactId=javax.servlet
    -Dversion=1.0.0</command>
${root.example.dir}/osgi/osgi-project $ <command>mvn pax:import-bundle \
    -DgroupId=org.apache.felix \
    -DartifactId=org.apache.felix.scr \
    -Dversion=1.0.8</command>
${root.example.dir}/osgi/osgi-project $ <command>mvn pax:import-bundle \
    -DgroupId=org.apache.felix \
    -DartifactId=org.apache.felix.http.jetty \
    -Dversion=1.0.1</command></screen>

      <para>Once you have bundled these OSGi bundles, you can start your
      runtme environment. Because the <varname>pax:import-bundle</varname>
      goal changes some of the POMs in your <varname>osgi-project</varname>,
      you will need to run <command>mvn install</command> before you can run
      <command>mvn pax:provision</command>.</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn install pax:provision</command>
[INFO] [pax:provision]
[INFO] Installing ${root.example.dir}/osgi/osgi-project/runner/target/pom-transformed.xml 
       to ${local.repo.dir}/org/sonatype/mcookbook/osgi-project/build/deployment/1.0-SNAPSHOT/deployment-1.0-SNAPSHOT.pom
    ______  ________  __  __
   / __  / /  __   / / / / /
  /  ___/ /  __   / _\ \ _/
 /  /    /  / /  / / _\ \
/__/    /__/ /__/ /_/ /_/

Pax Runner (1.0.0) from OPS4J - http://www.ops4j.org
----------------------------------------------------

 -&gt; Using config [classpath:META-INF/runner.properties]
 -&gt; Using only arguments from command line
 -&gt; Scan bundles from [${root.example.dir}/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Scan bundles from [scan-pom:file:${root.example.dir}/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.webconsole/1.2.8, 
at default start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/javax.servlet/1.0.0, at default start 
level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.http.jetty/1.0.1, 
at default start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.scr/1.0.8, at default 
start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Preparing framework [Felix 1.8.0]
 -&gt; Downloading bundles...
 -&gt; mvn:org.apache.felix/org.apache.felix.webconsole/1.2.8 : 102399 bytes 
 -&gt; mvn:org.apache.felix/javax.servlet/1.0.0 : 30450 bytes @ [ 10150kBps ]
 -&gt; mvn:org.apache.felix/org.apache.felix.http.jetty/1.0.1 : 102399 bytes @ 
 -&gt; mvn:org.apache.felix/org.apache.felix.scr/1.0.8 : 112058 bytes @ [ 8619kBps ]
 -&gt; Using execution environment [J2SE-1.5]
 -&gt; Runner has successfully finished his job!


Welcome to Felix.
=================

-&gt; org.mortbay.log:Logging to org.mortbay.log via org.apache.felix.http.jetty.LogServiceLog
org.mortbay.log:Init SecureRandom.
org.mortbay.log:started org.mortbay.jetty.servlet.HashSessionIdManager@34a33d
org.mortbay.log:started org.mortbay.jetty.servlet.HashSessionManager@46ac5a
org.mortbay.log:starting OsgiServletHandler@dd7786
org.mortbay.log:started OsgiServletHandler@dd7786
org.mortbay.log:starting SessionHandler@d23e75
org.mortbay.log:started SessionHandler@d23e75
org.mortbay.log:starting org.mortbay.jetty.servlet.Context@9deddb{/,null}
org.mortbay.log:starting ErrorHandler@28bda
org.mortbay.log:started ErrorHandler@28bda
org.mortbay.log:started org.mortbay.jetty.servlet.Context@9deddb{/,null}
org.mortbay.log:jetty-6.1.x
org.mortbay.log:started Realm[OSGi HTTP Service Realm]==[]
org.mortbay.log:started org.mortbay.thread.QueuedThreadPool@f13b08
org.mortbay.log:starting Server@5a936b
org.mortbay.log:started org.mortbay.jetty.nio.SelectChannelConnector$1@9576c3
org.mortbay.log:Started SelectChannelConnector@0.0.0.0:8080
org.mortbay.log:started SelectChannelConnector@0.0.0.0:8080
org.mortbay.log:started Server@5a936b
org.mortbay.log:started /system/console/*
org.mortbay.log:started /system/console/res
</screen>

      <para>After running mvn pax:provision, you have an instance of Felix
      that is running the Apache Felix Web Management Console application.
      Fire up a web brower, and go to <ulink
      url="http://localhost:8080/system/console">http://localhost:8080/system/console</ulink>
      to load the interface. The default administrative username and password
      is <varname>admin</varname>/<varname>admin</varname>.</para>

      <figure id="fig-osgi-felix-web-management">
        <title>Apache Felix Web Management Console</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="figs/web/osgi_felix-admin-console.png" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>

    <section>
      <title>Discussion</title>

      <para>Once you start the web management console for Apache Felix, you
      can start to manage the installed bundles. You can start and stop
      bundles via the interface, and you can install bundles from remote
      repositories. If you prefer to use the shell interface from the previous
      recipe, click on the Shell interface and you can enter in any of the
      commands you used at the command-line Felix management console as shown
      in <xref linkend="fig-osgi-felix-admin-console-shell" />.</para>

      <figure id="fig-osgi-felix-admin-console-shell">
        <title>Running the Apache Felix Shell via the Administrative Web
        Console</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="figs/web/osgi_felix-admin-console-shell.png" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>You can manage Felix interactions with events and repositories,
      and you can also restart, stop, and change the default run levels.
      Clicking on the "System Information" tab will also allow you to get some
      statistics about the runtime container as shown in <xref
      linkend="fig-osgi-felix-admin-console-system" />.</para>

      <figure id="fig-osgi-felix-admin-console-system">
        <title>Managing the Apache Felix via System Information</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="figs/web/osgi_felix-admin-console-system.png" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>

    <section>
      <title>Resources</title>

      <para>For more information about the Apache Felix Web Console, see
      <ulink
      url="http://cwiki.apache.org/confluence/display/FELIX/Apache+Felix+Web+Console">http://cwiki.apache.org/confluence/display/FELIX/Apache+Felix+Web+Console</ulink>.</para>
    </section>
  </section>

  <section>
    <title>Creating an OSGi Bundle with Maven</title>

    <section>
      <title>Problem</title>

      <para>You need to create you own OSGi bundle project to integrate with
      the runtime environment created in the previous recipes.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>Run the <varname>pax:create-bundle</varname> goal. The following
      screen listing runs the <varname>pax:create-bundle</varname> to create a
      new Maven project for an OSGi bundle with a package
      org.sonatype.mcookbook and a name <varname>osgi-bundle</varname>. Run
      this command from the
      <filename>${root.example.dir}/osgi/osgi-project</filename>
      directory:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn pax:create-bundle \
  -Dpackage=org.sonatype.mcookbook \
  -Dname=osgi-bundle \
  -Dversion=1.0-SNAPSHOT</command>
</screen>

      <para>Once this command has been completed, run <command>mvn install
      pax:provision</command> and then verify that the component is present by
      running <command>ps</command> at the Felix administrative
      console:</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">${root.example.dir}/osgi/osgi-project $ <command>mvn install pax:provision</command>
...
[INFO] Reactor build order: 
[INFO]   org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]   osgi-project - plugin configuration
[INFO]   osgi-project - wrapper instructions
[INFO]   osgi-project - bundle instructions
[INFO]   osgi-project - imported bundles
[INFO]   org.sonatype.mcookbook
..
[INFO] ------------------------------------------------------------------------
[INFO] Building org.sonatype.mcookbook
[INFO]    task-segment: [install]
[INFO] ------------------------------------------------------------------------
[INFO] [resources:resources]
[WARNING] Using platform encoding (MacRoman actually) to copy filtered resources, i.e. build is platform dependent!
[INFO] Copying 1 resource
[INFO] Copying 0 resource
[INFO] [pax:compile]
[INFO] Nothing to compile - all classes are up to date
[INFO] [pax:testCompile]
[INFO] No sources to compile
...
[INFO] [install:install]
[INFO] Installing /Users/tobrien/Library/Code/sonatype/maven-cookbook/mcookbook-examples/osgi/osgi-project/org.sonatype.mcookbook/target/org.sonatype.mcookbook-1.0-SNAPSHOT.jar to /Users/tobrien/.m2/repository/org/sonatype/mcookbook/osgi-project/org.sonatype.mcookbook/1.0-SNAPSHOT/org.sonatype.mcookbook-1.0-SNAPSHOT.jar
[INFO] [bundle:install]
[INFO] Parsing file:/Users/tobrien/.m2/repository/repository.xml
[INFO] Installing org/sonatype/mcookbook/osgi-project/org.sonatype.mcookbook/1.0-SNAPSHOT/org.sonatype.mcookbook-1.0-SNAPSHOT.jar
[INFO] Writing OBR metadata
[INFO] ------------------------------------------------------------------------
[INFO] Building org.sonatype.mcookbook.osgi-project (OSGi project)
[INFO]    task-segment: [pax:provision] (aggregator-style)
[INFO] ------------------------------------------------------------------------
</screen>

      <para>The Pax plugin bundles the new OSGi bundle into a JAR file which
      is deployed to the local Maven repository in ~/.m2/repository. The
      resulting artifact has the following identifiers:</para>

      <itemizedlist>
        <listitem>
          <para><emphasis>groupId:</emphasis>
          <varname>org.sonatype.mcookbook.osgi-project</varname></para>
        </listitem>

        <listitem>
          <para><emphasis>artifactId:</emphasis>
          <varname>org.sonatype.mcookbook</varname></para>
        </listitem>

        <listitem>
          <para><emphasis>version:</emphasis>
          <varname>1.0-SNAPSHOT</varname></para>
        </listitem>
      </itemizedlist>

      <para>Continuing on with this particular execution of Maven, lines
      corresponding to this new custom OSGi bundle have been highlighted. The
      <varname>mvn:org.sonatype.mcookbook.osgi-project/org.sonatype.mcookbook/1.0-SNAPSHOT</varname>
      is provisioned to Apache Felix and after running the
      <command>ps</command> command we see that the
      <varname>org.sonatype.mcookbook</varname> bundle is deployed with ID
      5.</para>

      <screen db:wrap="force" xmlns:db="http://discursive.com/plugins/docbook">[INFO] [pax:provision]
[INFO] Installing /Users/tobrien/Library/Code/sonatype/maven-cookbook/mcookbook-examples/osgi/osgi-project/runner/target/pom-transformed.xml to /Users/tobrien/.m2/repository/org/sonatype/mcookbook/osgi-project/build/deployment/1.0-SNAPSHOT/deployment-1.0-SNAPSHOT.pom

Pax Runner (1.0.0) from OPS4J - http://www.ops4j.org
----------------------------------------------------

 -&gt; Using config [classpath:META-INF/runner.properties]
 -&gt; Using only arguments from command line
 -&gt; Scan bundles from [/Users/tobrien/Library/Code/sonatype/maven-cookbook/mcookbook-examples/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Scan bundles from [scan-pom:file:/Users/tobrien/Library/Code/sonatype/maven-cookbook/mcookbook-examples/osgi/osgi-project/runner/deploy-pom.xml]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.webconsole/1.2.8, at default start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/javax.servlet/1.0.0, at default start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.scr/1.0.8, at default start level, bundle will be started, bundle will be loaded from the cache]
 -&gt; Provision bundle [mvn:org.apache.felix/org.apache.felix.http.jetty/1.0.1, at default start level, bundle will be started, bundle will be loaded from the cache]
<emphasis> -&gt; Provision bundle [mvn:org.sonatype.mcookbook.osgi-project/org.sonatype.mcookbook/1.0-SNAPSHOT, at default start level, bundle will be started, bundle will be loaded from the cache]
</emphasis> -&gt; Preparing framework [Felix 1.8.0]
...
 -&gt; Runner has successfully finished his job!


Welcome to Felix.
=================

-&gt; org.mortbay.log:Logging to org.mortbay.log via org.apache.felix.http.jetty.LogServiceLog
STARTING org.sonatype.mcookbook
REGISTER org.sonatype.mcookbook.ExampleService
org.mortbay.log:Init SecureRandom.
...
org.mortbay.log:started /system/console/res

-&gt; <command>ps</command>
START LEVEL 6
   ID   State         Level  Name
[   0] [Active     ] [    0] System Bundle (1.8.0)
[   1] [Active     ] [    5] Apache Felix Web Management Console (1.2.8)
[   2] [Active     ] [    5] Servlet 2.1 API (1.0.0)
[   3] [Active     ] [    5] Apache Felix Declarative Services (1.0.8)
[   4] [Active     ] [    5] HTTP Service (1.0.1)
<emphasis>[   5] [Active     ] [    5] org.sonatype.mcookbook (1.0.0.SNAPSHOT)</emphasis>
[   6] [Active     ] [    1] osgi.compendium (4.1.0.build-200702212030)
[   7] [Active     ] [    1] Apache Felix Shell Service (1.2.0)
[   8] [Active     ] [    1] Apache Felix Shell TUI (1.2.0)
</screen>
    </section>

    <section>
      <title>Discussion</title>

      <para></para>

      <figure>
        <title>Custom Bundle</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="figs/web/osgi_osgi-custom-bundle-fs.png" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>
  </section>

  <section>
    <title>Deploying OSGi Bundles to a Maven Repository</title>

    <section>
      <title>Problem</title>

      <para>You need to configure your project to deploy your own custom OSGi
      bundles to a Maven repository.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>The solution is to download an install Nexus Professional, and
      configure your Maven environment to deploy snapshot and release
      artifacts to a Hosted Maven repository. To install and configure Nexus
      Professional, complete the following steps:</para>

      <orderedlist>
        <listitem>
          <para>Download Nexus Professional from <ulink
          url="http://www.sonatype.com/products/downloads">http://www.sonatype.com/products/downloads</ulink>.</para>
        </listitem>

        <listitem>
          <para>Unpack the Nexus Professional archive on your local
          workstation, or on the machine that will host Nexus Professional for
          your workgroup or organization. </para>
        </listitem>

        <listitem>
          <para>Start Nexus Professional by running the startup script in
          ${nexus_install_dir}/bin/jsw</para>
        </listitem>
      </orderedlist>

      <note>
        <para>You can also setup and install Nexus Open Source, and rely on
        the first-class support that the the Pax plugin provides for OSGi
        bundles stored in a standard Maven repository. In the context of OSGi
        development, the main difference between Nexus Professional and Nexus
        Open Source is that Nexus Professional provides direct support for OBR
        repositories, allowing you to proxy, host, and group OSGi bundle
        repositories and convert existing Maven repositories to OSGi bundle
        repositories.</para>
      </note>
    </section>

    <section>
      <title>Discussion</title>

      <para></para>
    </section>
  </section>

  <section>
    <title>Transforming a Maven Repository into an OSGi Bundle
    Repository</title>

    <para>Now that you've published an OSGi bundle to a Maven repository, how
    would you consume it in an OSGi container like Apache Felix?</para>

    <section>
      <title>Problem</title>

      <para>You need to expose OSGi bundles in a Maven repository using the
      OBR repository format.</para>
    </section>

    <section>
      <title>Solution</title>

      <para>Use Nexus Professional, and create a virtual OBR repository which
      will</para>
    </section>

    <section>
      <title>Discussion</title>

      <para></para>
    </section>
  </section>

  <section>
    <title>Proxying OSGi Bundle Repositories</title>

    <para></para>

    <section>
      <title>Problem</title>

      <para></para>
    </section>

    <section>
      <title>Solution</title>

      <para></para>
    </section>

    <section>
      <title>Discussion</title>

      <para></para>
    </section>
  </section>

  <section>
    <title>Grouping OSGi Bundle Repositories</title>

    <para></para>
  </section>
</chapter>
